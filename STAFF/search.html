<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolyPals Global Search</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    ::-webkit-scrollbar{width:0;height:0;}
    body{-ms-overflow-style:none;scrollbar-width:none;
      background:linear-gradient(135deg,#6C63FF,#9D4EDD);
      min-height:100vh;color:white;overflow-x:hidden;}
    .search-header{position:sticky;top:0;z-index:10;backdrop-filter:blur(15px);
      background:rgba(255,255,255,0.1);padding:15px 20px;display:flex;justify-content:center;}
    .search-bar{width:100%;max-width:500px;display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);
      border-radius:30px;padding:10px 20px;}
    .search-bar input{flex:1;background:transparent;border:none;outline:none;color:white;font-size:16px;}
    .search-bar i{color:white;font-size:18px;}
    h2.section-title{margin:20px 25px 10px;font-size:18px;font-weight:600;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;padding:0 20px 60px;}
    .card{background:rgba(255,255,255,0.15);border-radius:20px;backdrop-filter:blur(15px);
      padding:15px;text-align:center;transition:.3s;cursor:pointer;opacity:0;animation:fadeIn .6s forwards;}
    .card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.25);}
    .card img{width:100%;height:200px;object-fit:cover;border-radius:15px;}
    .card.profile img{width:90px;height:90px;border-radius:50%;border:3px solid rgba(255,255,255,0.3);}
    .card h3{margin-top:10px;font-size:17px;}
    .card p{font-size:14px;opacity:.8;}
    @keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
  </style>
</head>
<body>

  <div class="search-header">
    <div class="search-bar">
      <i class="fa fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search names, polys, or stores...">
    </div>
  </div>

  <div id="resultsContainer"></div>

  <!-- 🔥 Firebase (Global) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="../../firebase-config.js"></script>

  <script>
    const db = window.db;
    const searchInput = document.getElementById("searchInput");
    const resultsContainer = document.getElementById("resultsContainer");
    const currentPoly = sessionStorage.getItem("polyId") || "psp";
    let polyList = [];

    // 🧩 Load all poly IDs once
    async function getAllPolyIds() {
      if (polyList.length > 0) return polyList;
      const regSnap = await db.collection("poly_registry").get();
      if (!regSnap.empty) {
        polyList = regSnap.docs.map(d => d.id.toLowerCase());
      } else {
        const polysSnap = await db.collection("polys").get();
        polyList = polysSnap.docs.map(d => d.id.toLowerCase());
      }
      return polyList;
    }

    async function searchAll(queryText) {
      const q = queryText.toLowerCase().trim();
      resultsContainer.innerHTML = "<p style='text-align:center;opacity:0.8;margin-top:20px;'>Searching...</p>";

      const polyIds = await getAllPolyIds();
      const accounts = [], communities = [], stores = [];
      const isPolySearch = polyIds.includes(q);

      for (const polyId of polyIds) {
        const [studentsSnap, staffSnap, postsSnap] = await Promise.all([
          db.collection("polys").doc(polyId).collection("students").get(),
          db.collection("polys").doc(polyId).collection("staffs").get(),
          db.collection("polys").doc(polyId).collection("posts").get()
        ]);

        // 👤 ACCOUNTS
        studentsSnap.forEach(doc => {
          const d = doc.data();
          if (!d.name) return;
          const name = d.name.toLowerCase();
          if ((isPolySearch && polyId === q) || name.includes(q)) {
            accounts.push({ ...d, id: doc.id, poly: polyId });
          }
        });
        staffSnap.forEach(doc => {
          const d = doc.data();
          if (!d.name) return;
          const name = d.name.toLowerCase();
          if ((isPolySearch && polyId === q) || name.includes(q)) {
            accounts.push({ ...d, id: doc.id, poly: polyId });
          }
        });

        // 🏢 COMMUNITY (HEP posts only)
        postsSnap.forEach(doc => {
          const d = doc.data();
          if (d.role !== "HEP") return;
          const caption = (d.caption || "").toLowerCase();
          const topic = (d.topic || "").toLowerCase();
          if ((isPolySearch && polyId === q) || caption.includes(q) || topic.includes(q)) {
            communities.push({ ...d, id: doc.id, poly: polyId });
          }
        });
      }

      // 🏬 STORES (only current poly)
      const shopsSnap = await db.collection("polys").doc(currentPoly).collection("shops").get();
      shopsSnap.forEach(doc => {
        const d = doc.data();
        if (d.storeName && d.storeName.toLowerCase().includes(q) && d.polyId === currentPoly)
          stores.push({ ...d, id: doc.id });
      });

      renderResults(accounts, communities, stores, isPolySearch ? q : null);
    }

    function renderResults(accounts, communities, stores, polyMatch) {
      resultsContainer.innerHTML = "";

      // ACCOUNTS
      if (accounts.length > 0) {
        resultsContainer.innerHTML += `<h2 class="section-title">Accounts${polyMatch ? ' ('+polyMatch.toUpperCase()+')' : ''}</h2><div class="grid" id="accGrid"></div>`;
        const grid = document.getElementById("accGrid");
        accounts.forEach(u => {
          const img = u.photoURL || u.profilePic || "https://placehold.co/100x100/6C63FF/FFF?text=User";
          const html = `
            <div class="card profile"
                 onclick="openProfilePage('${u.id}','${u.poly}')">
              <img src="${img}" alt="${u.name}">
              <h3>${u.name}</h3>
              <p>${u.course || u.department || ''} (${u.poly.toUpperCase()})</p>
            </div>`;
          grid.insertAdjacentHTML("beforeend", html);
        });
      }

      // STORES
      if (stores.length > 0) {
        resultsContainer.innerHTML += `<h2 class="section-title">Stores (${currentPoly.toUpperCase()})</h2><div class="grid" id="storeGrid"></div>`;
        const grid = document.getElementById("storeGrid");
        stores.forEach(s => {
          grid.insertAdjacentHTML("beforeend", `
            <div class="card" onclick="openStorePage('${s.id}')">
              <img src="${s.logoUrl || 'https://placehold.co/400x300/C77DFF/FFF?text=Store'}">
              <h3>${s.storeName}</h3>
              <p>${s.category || ''}</p>
            </div>`);
        });
      }

      // COMMUNITY POSTS
      if (communities.length > 0) {
        resultsContainer.innerHTML += `<h2 class="section-title">Community (HEP)</h2><div class="grid" id="comGrid"></div>`;
        const grid = document.getElementById("comGrid");
        communities.forEach(p => {
          grid.insertAdjacentHTML("beforeend", `
            <div class="card" onclick="openPostPage('${p.id}','${p.poly}')">
              <img src="${p.mediaUrl || 'https://placehold.co/400x300/9D4EDD/FFF?text=HEP+Post'}">
              <h3>${p.topic || 'Announcement'}</h3>
              <p>${p.caption || ''} (${p.poly.toUpperCase()})</p>
            </div>`);
        });
      }

      if (accounts.length === 0 && stores.length === 0 && communities.length === 0) {
        resultsContainer.innerHTML = "<p style='text-align:center;opacity:0.8;margin-top:30px;'>No results found.</p>";
      }
    }

    // 🔍 search trigger
    searchInput.addEventListener("input", e => {
      const val = e.target.value.trim();
      if (val.length > 0) searchAll(val);
      else resultsContainer.innerHTML = "";
    });

    // -----------------------------
    // 🚀 Redirect Handlers
    // -----------------------------
    function openProfilePage(uid, polyId) {
  localStorage.setItem("publicUserId", uid);
  localStorage.setItem("publicUserPolyId", polyId); // ✅ use separate key
  window.location.href = "../public-profile.html";
}


    function openStorePage(storeId) {
      window.location.href = `store.html?id=${storeId}&poly=${currentPoly}`;
    }

    function openPostPage(postId, polyId) {
      window.location.href = `post.html?id=${postId}&poly=${polyId}`;
    }
  </script>
</body>
</html>
